<div class="books-page">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Books Management</h2>
    <button class="btn btn-danger" (click)="openCreateBookForm()">
      <i class="bi bi-plus-circle"></i> Create New Book
    </button>
  </div>

  <!-- Filters Section -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Search</label>
          <div class="input-group">
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="searchQuery"
              (keyup.enter)="onSearch()"
              placeholder="Search books by title, author...">
            <button class="btn btn-danger" type="button" (click)="onSearch()">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Sort By</label>
          <select class="form-select" [(ngModel)]="sortBy" (change)="onSortChange()">
            <option value="createdAt">Newest First</option>
            <option value="-createdAt">Oldest First</option>
            <option value="price">Price: Low to High</option>
            <option value="-price">Price: High to Low</option>
            <option value="title">Title: A-Z</option>
            <option value="-title">Title: Z-A</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Category</label>
          <select class="form-select" [(ngModel)]="selectedCategory" (change)="onCategoryChange()">
            <option value="">All Categories</option>
            <option *ngFor="let cat of categories" [value]="cat._id || cat.id">{{ cat.name }}</option>
          </select>
        </div>
        <div class="col-md-1">
          <label class="form-label">Min Price</label>
          <input 
            type="number" 
            class="form-control" 
            [(ngModel)]="minPrice"
            (change)="onPriceFilterChange()"
            placeholder="Min">
        </div>
        <div class="col-md-1">
          <label class="form-label">Max Price</label>
          <input 
            type="number" 
            class="form-control" 
            [(ngModel)]="maxPrice"
            (change)="onPriceFilterChange()"
            placeholder="Max">
        </div>
        <div class="col-md-1">
          <label class="form-label">Status</label>
          <select class="form-select" [(ngModel)]="statusFilter" (change)="onStatusFilterChange()">
            <option value="all">All</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="col-md-1">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-outline-secondary w-100" (click)="clearFilters()">
            <i class="bi bi-x-circle"></i> Clear
          </button>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-12">
          <small class="text-muted">Results: {{ totalBooks }} books found</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-danger" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading books...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="alert alert-danger" role="alert">
    {{ error }}
  </div>

  <!-- Books Table -->
  <div *ngIf="!loading && !error" class="card shadow-sm">
    <div class="card-body">
      <div *ngIf="books.length === 0" class="text-center py-5">
        <i class="bi bi-inbox fs-1 text-muted"></i>
        <p class="text-muted mt-3">No books found. Try adjusting your filters.</p>
      </div>

      <div class="table-responsive" *ngIf="books.length > 0">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Image</th>
              <th>Title</th>
              <th>Author(s)</th>
              <th>Category</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let book of books">
              <td>
                <img 
                  *ngIf="book.image?.url" 
                  [src]="book.image.url" 
                  [alt]="book.title"
                  class="book-thumbnail">
                <span *ngIf="!book.image?.url" class="text-muted">No image</span>
              </td>
              <td><strong>{{ book.title }}</strong></td>
              <td>
                <span *ngFor="let author of (book.authors || []); let last = last">
                  {{ author.name || author }}{{ !last ? ', ' : '' }}
                </span>
                <span *ngIf="!book.authors || book.authors.length === 0" class="text-muted">No author</span>
              </td>
              <td>
                <span *ngFor="let cat of (book.categories || []); let last = last">
                  {{ cat.name || cat }}{{ !last ? ', ' : '' }}
                </span>
                <span *ngIf="!book.categories || book.categories.length === 0" class="text-muted">No category</span>
              </td>
              <td>{{ book.price | number:'1.2-2' }} EGP</td>
              <td>{{ book.stock }}</td>
              <td>
                <span class="badge" [ngClass]="book.isActive ? 'bg-success' : 'bg-secondary'">
                  {{ book.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-primary" (click)="openEditBookForm(book)" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" (click)="deleteBook(book)" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav *ngIf="totalPages > 1" aria-label="Books pagination" class="mt-4">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="onPageChange(currentPage - 1)" style="cursor: pointer;">Previous</a>
          </li>
          <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
            <a class="page-link" (click)="onPageChange(page)" style="cursor: pointer;">{{ page }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="onPageChange(currentPage + 1)" style="cursor: pointer;">Next</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Step 1: Required Fields Form (Create New Book) -->
<div class="modal fade" [class.show]="showBookForm && !editingBook" [style.display]="(showBookForm && !editingBook) ? 'block' : 'none'" 
     tabindex="-1" *ngIf="showBookForm && !editingBook" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Create New Book - Step 1: Required Information
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeBookForm()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Please fill in the required fields to create the book. You can add more details in the next step.
        </div>
        <form>
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="requiredTitle" class="form-label">Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="requiredTitle" [(ngModel)]="requiredForm.title" name="requiredTitle" required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="requiredPrice" class="form-label">Price <span class="text-danger">*</span></label>
                <input type="number" step="0.01" min="0" class="form-control" id="requiredPrice" [(ngModel)]="requiredForm.price" name="requiredPrice" required>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="requiredStock" class="form-label">Stock <span class="text-danger">*</span></label>
                <input type="number" min="0" class="form-control" id="requiredStock" [(ngModel)]="requiredForm.stock" name="requiredStock" required>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Authors <span class="text-danger">*</span></label>
            <div class="border rounded p-3" style="max-height: 150px; overflow-y: auto;">
              <div *ngFor="let author of authors" class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [id]="'required-author-' + (author._id || author.id)"
                  [checked]="isRequiredAuthorSelected(author._id || author.id)"
                  (change)="onRequiredAuthorSelect(author._id || author.id)">
                <label class="form-check-label" [for]="'required-author-' + (author._id || author.id)">
                  {{ author.name }}
                </label>
              </div>
              <div *ngIf="authors.length === 0" class="text-muted">No authors available</div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeBookForm()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="submitRequiredForm()">
          <i class="bi bi-plus-circle"></i> Create Book
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Step 2: Details Form (Fill Book Details) -->
<div class="modal fade" [class.show]="showDetailsForm" [style.display]="showDetailsForm ? 'block' : 'none'" 
     tabindex="-1" *ngIf="showDetailsForm" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-pencil"></i> Fill Book Details - Step 2: Optional Information
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeDetailsForm()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success">
          <i class="bi bi-check-circle"></i> Book created successfully! Now you can add optional details.
        </div>
        <form enctype="multipart/form-data">
          <div class="mb-3">
            <label for="detailsDescription" class="form-label">Description</label>
            <textarea class="form-control" id="detailsDescription" rows="4" [(ngModel)]="detailsForm.description" name="detailsDescription"></textarea>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="detailsIsbn" class="form-label">ISBN</label>
                <input type="text" class="form-control" id="detailsIsbn" [(ngModel)]="detailsForm.isbn" name="detailsIsbn">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="detailsSku" class="form-label">SKU</label>
                <input type="text" class="form-control" id="detailsSku" [(ngModel)]="detailsForm.sku" name="detailsSku">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="detailsPublisher" class="form-label">Publisher</label>
                <input type="text" class="form-control" id="detailsPublisher" [(ngModel)]="detailsForm.publisher" name="detailsPublisher">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="detailsLanguage" class="form-label">Language</label>
                <input type="text" class="form-control" id="detailsLanguage" [(ngModel)]="detailsForm.language" name="detailsLanguage">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="detailsPublishedAt" class="form-label">Published Date</label>
                <input type="date" class="form-control" id="detailsPublishedAt" [(ngModel)]="detailsForm.publishedAt" name="detailsPublishedAt">
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="detailsImageFile" class="form-label">Book Cover Image</label>
            <input type="file" class="form-control" id="detailsImageFile" accept="image/*" (change)="onImageFileSelected($event, false)" name="image">
            <div class="form-text">Upload a cover image for the book (JPG, PNG, etc.)</div>
            <small class="text-muted" *ngIf="selectedImageFile">Selected: {{ selectedImageFile.name }}</small>
          </div>

          <div class="mb-3">
            <label for="detailsPdfFile" class="form-label">Book PDF</label>
            <input type="file" class="form-control" id="detailsPdfFile" accept=".pdf" (change)="onPdfFileSelected($event, false)" name="book">
            <div class="form-text">Upload the book PDF file</div>
            <small class="text-muted" *ngIf="selectedPdfFile">Selected: {{ selectedPdfFile.name }}</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Categories</label>
            <div class="border rounded p-3" style="max-height: 150px; overflow-y: auto;">
              <div *ngFor="let category of categories" class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [id]="'details-cat-' + (category._id || category.id)"
                  [checked]="isDetailsCategorySelected(category._id || category.id)"
                  (change)="onDetailsCategorySelect(category._id || category.id)">
                <label class="form-check-label" [for]="'details-cat-' + (category._id || category.id)">
                  {{ category.name }}
                </label>
              </div>
              <div *ngIf="categories.length === 0" class="text-muted">No categories available</div>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="detailsIsActive"
                [(ngModel)]="detailsForm.isActive"
                name="detailsIsActive">
              <label class="form-check-label" for="detailsIsActive">
                Active (visible to customers)
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDetailsForm()">Skip & Close</button>
        <button type="button" class="btn btn-primary" (click)="submitDetailsForm()">
          <i class="bi bi-check"></i> Update Details
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Book Form (for existing books) -->
<div class="modal fade" [class.show]="showBookForm && editingBook" [style.display]="(showBookForm && editingBook) ? 'block' : 'none'" 
     tabindex="-1" *ngIf="showBookForm && editingBook" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="bi bi-pencil"></i> Edit Book
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeBookForm()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form encrypt="multipart/form-data" method="post">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="title" [(ngModel)]="bookForm.title" name="title" required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="price" class="form-label">Price <span class="text-danger">*</span></label>
                <input type="number" step="0.01" min="0" class="form-control" id="price" [(ngModel)]="bookForm.price" name="price" required>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" rows="4" [(ngModel)]="bookForm.description" name="description"></textarea>
          </div>

          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="stock" class="form-label">Stock <span class="text-danger">*</span></label>
                <input type="number" min="0" class="form-control" id="stock" [(ngModel)]="bookForm.stock" name="stock" required>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="isbn" class="form-label">ISBN</label>
                <input type="text" class="form-control" id="isbn" [(ngModel)]="bookForm.isbn" name="isbn">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="sku" class="form-label">SKU</label>
                <input type="text" class="form-control" id="sku" [(ngModel)]="bookForm.sku" name="sku">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="publisher" class="form-label">Publisher</label>
                <input type="text" class="form-control" id="publisher" [(ngModel)]="bookForm.publisher" name="publisher">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="language" class="form-label">Language</label>
                <input type="text" class="form-control" id="language" [(ngModel)]="bookForm.language" name="language">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="publishedAt" class="form-label">Published Date</label>
                <input type="date" class="form-control" id="publishedAt" [(ngModel)]="bookForm.publishedAt" name="publishedAt">
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="imageFile" class="form-label">Book Cover Image</label>
            <input type="file" class="form-control" id="imageFile" accept="image/*" (change)="onImageFileSelected($event, true)" name="image">
            <div class="form-text">Upload a cover image for the book (JPG, PNG, etc.)</div>
            <small class="text-muted" *ngIf="selectedEditImageFile">Selected: {{ selectedEditImageFile.name }}</small>
            <small class="text-muted" *ngIf="!selectedEditImageFile && bookForm.image?.url">Current: {{ bookForm.image.url }}</small>
          </div>

          <div class="mb-3">
            <label for="pdfFile" class="form-label">Book PDF</label>
            <input type="file" class="form-control" id="pdfFile" accept=".pdf" (change)="onPdfFileSelected($event, true)" name="book">
            <div class="form-text">Upload the book PDF file</div>
            <small class="text-muted" *ngIf="selectedEditPdfFile">Selected: {{ selectedEditPdfFile.name }}</small>
            <small class="text-muted" *ngIf="!selectedEditPdfFile && bookForm.pdfUrl">Current: {{ bookForm.pdfUrl }}</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Authors</label>
            <div class="border rounded p-3" style="max-height: 150px; overflow-y: auto;">
              <div *ngFor="let author of authors" class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [id]="'author-' + (author._id || author.id)"
                  [checked]="isAuthorSelected(author._id || author.id)"
                  (change)="onAuthorSelect(author._id || author.id)">
                <label class="form-check-label" [for]="'author-' + (author._id || author.id)">
                  {{ author.name }}
                </label>
              </div>
              <div *ngIf="authors.length === 0" class="text-muted">No authors available</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Categories</label>
            <div class="border rounded p-3" style="max-height: 150px; overflow-y: auto;">
              <div *ngFor="let category of categories" class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [id]="'cat-' + (category._id || category.id)"
                  [checked]="isCategorySelected(category._id || category.id)"
                  (change)="onCategorySelect(category._id || category.id)">
                <label class="form-check-label" [for]="'cat-' + (category._id || category.id)">
                  {{ category.name }}
                </label>
              </div>
              <div *ngIf="categories.length === 0" class="text-muted">No categories available</div>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="isActive"
                [(ngModel)]="bookForm.isActive"
                name="isActive">
              <label class="form-check-label" for="isActive">
                Active (visible to customers)
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeBookForm()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="submitBookForm()">
          <i class="bi bi-check"></i> Update Book
        </button>
      </div>
    </div>
  </div>
</div>

