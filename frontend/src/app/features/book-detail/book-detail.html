<app-header></app-header>

<div class="container py-5" *ngIf="loading">
  <div class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading book details...</p>
  </div>
</div>

<div class="container py-5" *ngIf="error">
  <div class="alert alert-danger" role="alert">
    <h4 class="alert-heading">Error!</h4>
    <p>{{ error }}</p>
    <hr>
    <button class="btn btn-primary" (click)="goBack()">Go Back</button>
  </div>
</div>

<div class="container py-5" *ngIf="book && !loading">
  <button class="btn btn-outline-secondary mb-4" (click)="goBack()">
    <i class="bi bi-arrow-left"></i> Back to Books
  </button>

  <div class="row g-5">
    <!-- Book Image -->
    <div class="col-12 col-md-5">
      <div class="book-image-container position-relative">
        <img [src]="book.image?.url || palceholderCover" [alt]="book.title" class="img-fluid rounded shadow-lg w-100"
          style="max-height: 700px; object-fit: cover;">
        <div class="book-badge position-absolute top-0 end-0 m-3" *ngIf="book.discount">
          <span class="badge bg-danger fs-6 px-3 py-2">10% off</span>
        </div>
      </div>
    </div>

    <!-- Book Details -->
    <div class="col-12 col-md-7">
      <h1 class="display-5 fw-bold mb-3 text-dark">{{ book.title }}</h1>

      <!-- Author -->
      <div class="mb-3">
        <h5 class="text-muted mb-0">
          <i class="bi bi-person me-2"></i>
          <span *ngIf="book.authors && book.authors.length > 0">
            <span *ngFor="let author of book.authors; let last = last">
              {{ author.name || author }}{{ !last ? ', ' : '' }}
            </span>
          </span>
          <span *ngIf="!book.authors || book.authors.length === 0">
            {{ book.author?.name || book.author || 'Unknown Author' }}
          </span>
        </h5>
      </div>

      <!-- Rating -->
      <div class="mb-4" *ngIf="book.ratingAvg > 0">
        <div class="d-flex align-items-center">
          <span class="text-warning me-2">
            <i class="bi bi-star-fill fs-5" *ngFor="let i of getStars(book.ratingAvg)"></i>
            <i class="bi bi-star fs-5" *ngFor="let i of getEmptyStars(book.ratingAvg)"></i>
          </span>
          <span class="me-2 fw-semibold">{{ book.ratingAvg.toFixed(1) }}</span>
          <span class="text-muted">({{ book.ratingCount }} reviews)</span>
        </div>
      </div>

      <!-- Price -->
      <div class="mb-4">
        <div class="d-flex align-items-baseline gap-3 mb-2">
          <h2 class="text-danger fw-bold mb-0">{{ book.price }} EGP</h2>
          <span class="text-decoration-line-through text-muted fs-5" *ngIf="book.originalPrice">{{ book.originalPrice }} EGP</span>
        </div>
        <div class="mb-3">
          <span class="badge bg-success fs-6 px-3 py-2" *ngIf="book.stock > 0">
            <i class="bi bi-check-circle me-1"></i>In Stock<span *ngIf="book.stock <= 5"> ({{ book.stock }} available)</span>
          </span>
          <span class="badge bg-danger fs-6 px-3 py-2" *ngIf="book.stock === 0">
            <i class="bi bi-x-circle me-1"></i>Out of Stock
          </span>
        </div>
      </div>

      <!-- Description -->
      <div class="mb-4" *ngIf="book.description">
        <h5 class="fw-bold mb-3">Description</h5>
        <p class="text-muted lh-lg">{{ book.description }}</p>
      </div>

      <!-- Action Buttons -->
      <div class="mb-5">
        <div class="d-flex gap-3 flex-wrap">
          <button mat-raised-button class="px-5 py-3 bg-danger text-white border-0" style="font-size: 1.1rem;"
            (click)="addToCart()" [disabled]="book.stock === 0">
            <i class="bi bi-cart-plus me-2"></i> Add to Cart
          </button>
          <button mat-stroked-button class="px-5 py-3 border-danger text-danger" style="font-size: 1.1rem;">
            <i class="bi bi-heart me-2"></i> Add to Wishlist
          </button>
        </div>
      </div>

      <!-- Book Details Card -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <h5 class="card-title fw-bold mb-4">Book Details</h5>
          <div class="row g-3">
            <div class="col-6" *ngIf="book.isbn">
              <div class="detail-item">
                <label class="text-muted small mb-1 d-block">ISBN</label>
                <div class="fw-semibold">{{ book.isbn }}</div>
              </div>
            </div>
            <div class="col-6" *ngIf="book.sku">
              <div class="detail-item">
                <label class="text-muted small mb-1 d-block">SKU</label>
                <div class="fw-semibold">{{ book.sku }}</div>
              </div>
            </div>
            <div class="col-6" *ngIf="book.publisher">
              <div class="detail-item">
                <label class="text-muted small mb-1 d-block">Publisher</label>
                <div class="fw-semibold">{{ book.publisher }}</div>
              </div>
            </div>
            <div class="col-6" *ngIf="book.language">
              <div class="detail-item">
                <label class="text-muted small mb-1 d-block">Language</label>
                <div class="fw-semibold">{{ book.language }}</div>
              </div>
            </div>
            <div class="col-6" *ngIf="book.publishedAt">
              <div class="detail-item">
                <label class="text-muted small mb-1 d-block">Published</label>
                <div class="fw-semibold">{{ book.publishedAt | date:'mediumDate' }}</div>
              </div>
            </div>
            <div class="col-12" *ngIf="book.categories && book.categories.length > 0">
              <div class="detail-item">
                <label class="text-muted small mb-1 d-block">Categories</label>
                <div>
                  <span *ngFor="let category of book.categories; let last = last" class="me-2">
                    <span class="badge bg-secondary px-3 py-2">{{ category.name || category }}</span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>



      <!-- Additional Info -->
      <div class="card border-0 bg-light">
        <div class="card-body p-4">
          <div class="row g-4 text-center">
            <div class="col-6 col-md-3">
              <i class="bi bi-truck fs-3 text-danger mb-2 d-block"></i>
              <div class="small fw-semibold">Free Delivery</div>
            </div>
            <div class="col-6 col-md-3">
              <i class="bi bi-shield-check fs-3 text-danger mb-2 d-block"></i>
              <div class="small fw-semibold">Quality Guarantee</div>
            </div>
            <div class="col-6 col-md-3">
              <i class="bi bi-arrow-repeat fs-3 text-danger mb-2 d-block"></i>
              <div class="small fw-semibold">Easy Returns</div>
            </div>
            <div class="col-6 col-md-3">
              <i class="bi bi-headset fs-3 text-danger mb-2 d-block"></i>
              <div class="small fw-semibold">24/7 Support</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="reviews-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold mb-0">Customer Reviews</h2>
      <button 
        *ngIf="isAuthenticated() && hasPurchasedBook && !userHasReviewed && !isCheckingPurchase"
        mat-raised-button 
        color="primary"
        (click)="showReviewFormDialog()"
        class="d-flex align-items-center gap-2">
        <i class="bi bi-pencil-square"></i> Write a Review
      </button>
      <button 
        *ngIf="!isAuthenticated()"
        mat-stroked-button
        (click)="showReviewFormDialog()"
        class="d-flex align-items-center gap-2">
        <i class="bi bi-pencil-square"></i> Write a Review
      </button>
    </div>

    <!-- Review Form -->
    <div class="card border-primary mb-4" *ngIf="showReviewForm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Write Your Review</h5>
      </div>
      <div class="card-body">
        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">
          <div class="mb-3">
            <label class="form-label fw-semibold">Rating <span class="text-danger">*</span></label>
            <div class="rating-input">
              <button 
                type="button" 
                *ngFor="let i of [1,2,3,4,5]; let idx = index"
                class="btn btn-link p-0 me-1"
                (click)="reviewForm.patchValue({rating: idx + 1})"
                [class.text-warning]="reviewForm.value.rating >= idx + 1"
                [class.text-muted]="reviewForm.value.rating < idx + 1">
                <i class="bi bi-star-fill fs-3"></i>
              </button>
              <span class="ms-2 text-muted">{{ reviewForm.value.rating }} out of 5</span>
            </div>
            <div *ngIf="reviewForm.get('rating')?.invalid && reviewForm.get('rating')?.touched" class="text-danger small mt-1">
              Please select a rating
            </div>
          </div>

          <div class="mb-3">
            <label for="reviewText" class="form-label fw-semibold">Your Review (Optional)</label>
            <textarea 
              id="reviewText"
              class="form-control" 
              rows="4" 
              formControlName="review"
              placeholder="Share your thoughts about this book..."></textarea>
          </div>

          <div class="d-flex gap-2">
            <button 
              type="submit" 
              mat-raised-button 
              color="primary"
              [disabled]="isSubmittingReview || !reviewForm.valid">
              <span *ngIf="!isSubmittingReview">Submit Review</span>
              <span *ngIf="isSubmittingReview">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Submitting...
              </span>
            </button>
            <button 
              type="button" 
              mat-stroked-button
              (click)="cancelReviewForm()"
              [disabled]="isSubmittingReview">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="review-summary" *ngIf="book.ratingCount > 0">
      <div class="row align-items-center">
        <div class="col-md-4 text-center">
          <h3 class="display-4 fw-bold mb-0">{{ book.ratingAvg.toFixed(1) }}</h3>
          <p class="text-muted mb-0">out of 5</p>
        </div>
        <div class="col-md-8">
          <div class="d-flex align-items-center mb-2">
            <span class="text-warning me-2">
              <i class="bi bi-star-fill" *ngFor="let i of getStars(book.ratingAvg)"></i>
              <i class="bi bi-star" *ngFor="let i of getEmptyStars(book.ratingAvg)"></i>
            </span>
            <span class="fw-semibold">{{ book.ratingAvg.toFixed(1) }} average</span>
          </div>
          <p class="text-muted">Based on {{ book.ratingCount }} reviews</p>
        </div>
      </div>
    </div>

    <div class="text-center py-5" *ngIf="reviewsLoading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading reviews...</span>
      </div>
      <p class="mt-3">Loading reviews...</p>
    </div>

    <div class="alert alert-warning" *ngIf="!reviewsLoading && reviewsError">
      <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ reviewsError }}
    </div>

    <div class="text-center py-5" *ngIf="!reviewsLoading && !reviewsError && reviews.length === 0">
      <i class="bi bi-chat-square-text fs-1 text-muted d-block mb-3"></i>
      <h4 class="text-muted">No Reviews Yet</h4>
      <p>Be the first to review this book!</p>
    </div>

    <div class="reviews-list" *ngIf="!reviewsLoading && !reviewsError && reviews.length > 0">
      <div class="review-item" *ngFor="let review of reviews">
        <div class="row">
          <div class="col-12 col-md-3">
            <div class="review-author">{{ review.userId?.FirstName || 'User' }} {{ review.userId?.LastName || '' }}</div>
            <div class="review-date">{{ review.createdAt | date:'mediumDate' }}</div>
          </div>
          <div class="col-12 col-md-9 mt-3 mt-md-0">
            <div class="review-rating mb-2">
              <span class="me-2">
                <i class="bi bi-star-fill" *ngFor="let i of getStars(review.rating)"></i>
                <i class="bi bi-star" *ngFor="let i of getEmptyStars(review.rating)"></i>
              </span>
            </div>
            <p class="review-body">{{ review.review }}</p>
          </div>
        </div>
      </div>
    </div>

    <nav class="pagination-nav" *ngIf="!reviewsLoading && reviewPagination && reviewPagination.totalPages > 1">
      <button class="btn btn-outline-secondary" 
              [disabled]="currentReviewPage === 1"
              (click)="onReviewPageChange(currentReviewPage - 1)">
        <i class="bi bi-arrow-left"></i> Previous
      </button>

      <span class="page-info">
        Page {{ currentReviewPage }} of {{ reviewPagination.totalPages }}
      </span>

      <button class="btn btn-outline-secondary" 
              [disabled]="currentReviewPage === reviewPagination.totalPages"
              (click)="onReviewPageChange(currentReviewPage + 1)">
        Next <i class="bi bi-arrow-right"></i>
      </button>
    </nav>

  </div>
</div>

<!-- Fallback if nothing else shows -->
<div class="container py-5" *ngIf="!loading && !book && !error">
  <div class="alert alert-warning">
    <h4>No Data</h4>
    <p>Component loaded but no book data available.</p>
    <button class="btn btn-primary" (click)="goBack()">Go Back</button>
  </div>
</div>

<app-footer></app-footer>